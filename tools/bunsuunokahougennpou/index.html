<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Fraction Visualizer</title>
    <style>body{font-family:sans-serif;text-align:center;background:#f4f7f9;margin:0;padding:10px}.c{max-width:1000px;margin:auto}h3{font-size:16px;margin:10px 0;color:#555}.p{background:#fff;padding:8px 15px;border-radius:8px;margin-bottom:10px;display:inline-flex;justify-content:center;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}.g{text-align:center;display:flex;flex-direction:column;align-items:center}.g input{width:35px;text-align:center;font-size:16px;font-weight:bold;color:#333;border:1px solid #ccc;border-radius:4px;padding:2px;-moz-appearance:textfield}.g input::-webkit-outer-spin-button,.g input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.l{width:100%;height:2px;background:#555;margin:2px auto}.o{font-size:16px;padding:0 4px;border-radius:4px;border:1px solid #ccc;cursor:pointer;height:26px}.b{padding:4px 12px;cursor:pointer;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;border:none;border-radius:20px;font-size:13px;font-weight:bold;box-shadow:0 2px 5px rgba(79,172,254,0.3);margin-left:5px}.b:hover{opacity:0.9}canvas{background:transparent;max-width:100%;display:block;margin:auto}</style>
</head>
<body>
<div class="c">
    <h3 id="t1"></h3>
    <div class="p">
        <div class="g"><input type="number" id="n1" value="2"><div class="l"></div><input type="number" id="d1" value="3"></div>
        <select id="op" class="o"><option value="+">+</option><option value="-">-</option></select>
        <div class="g"><input type="number" id="n2" value="2"><div class="l"></div><input type="number" id="d2" value="3"></div>
        <button class="b" id="bt" onclick="window._x()"></button>
    </div>
    <canvas id="cv" width="1000" height="800"></canvas>
</div>
<script>
(function(){
    const _d=document,_m=Math,_c=_d.getElementById('cv'),_q=_c.getContext('2d'),_r=50,_g=110,_o=90,_rg=160,_tm=120,_bm=100;
    const _cl={b:{f:'#4facfe',s:'#00f2fe'},g:{f:'#43e97b',s:'#38f9d7'},t:'#333',s:'#888',a:'#ccc'};
    
    // 文字列の復元
    _d.getElementById('t1').textContent = '\u5206\u6570\u53ef\u8996\u5316\u30c4\u30fc\u30eb';
    _d.getElementById('bt').textContent = '\u8a08\u7b97';

    const _gcd = (a, b) => b === 0 ? a : _gcd(b, a % b);

    const _txt = (x, y, t, f, c, b = 'middle') => {
        _q.fillStyle = c; _q.font = f; _q.textAlign = 'center'; _q.textBaseline = b;
        _q.fillText(t, x, y);
    };

    const _fTxt = (x, y, n, d, l) => {
        _txt(x, y - 65, l, '16px sans-serif', _cl.s);
        _txt(x, y - 15, n, 'bold 28px sans-serif', _cl.t);
        _q.fillRect(x - 30, y - 5, 60, 4);
        _txt(x, y + 35, d, 'bold 28px sans-serif', _cl.t);
    };

    const _stk = (x, by, n, d, f, s) => {
        let cn = _m.max(1, _m.ceil(n / d));
        for (let i = 0; i < cn; i++) {
            let y = by - _r - (i * _g);
            _q.beginPath(); _q.arc(x, y, _r, 0, _m.PI * 2);
            _q.fillStyle = '#fff'; _q.fill();
            for (let j = 0; j < d; j++) {
                if (i * d + j < n) {
                    let sA = (_m.PI * 2 / d) * j - _m.PI / 2, eA = (_m.PI * 2 / d) * (j + 1) - _m.PI / 2;
                    _q.beginPath(); _q.moveTo(x, y); _q.arc(x, y, _r, sA, eA);
                    _q.fillStyle = f; _q.globalAlpha = 0.8; _q.fill();
                    _q.strokeStyle = '#fff'; _q.lineWidth = 2; _q.stroke();
                }
            }
            _q.globalAlpha = 1; _q.beginPath(); _q.arc(x, y, _r, 0, _m.PI * 2);
            _q.strokeStyle = s; _q.lineWidth = 3; _q.stroke();
        }
    };

    window._x = function() {
        const n1=parseInt(_d.getElementById('n1').value), d1=parseInt(_d.getElementById('d1').value);
        const n2=parseInt(_d.getElementById('n2').value), d2=parseInt(_d.getElementById('d2').value);
        const op=_d.getElementById('op').value;
        if (d1 <= 0 || d2 <= 0) return;

        const cD = (d1 === d2) ? d1 : (d1 * d2) / _gcd(d1, d2);
        const rN1 = n1 * (cD / d1), rN2 = n2 * (cD / d2);
        const fN = (op === "+") ? rN1 + rN2 : rN1 - rN2;
        const nc = (d1 !== d2);

        const r1m = nc ? _m.max(_m.ceil(n1/d1), _m.ceil(n2/d2)) : _m.max(_m.ceil(n1/d1), _m.ceil(n2/d2), _m.ceil(_m.abs(fN)/cD));
        const r2m = nc ? _m.max(_m.ceil(rN1/cD), _m.ceil(rN2/cD), _m.ceil(_m.abs(fN)/cD)) : 0;

        _c.height = _tm + (r1m * _g) + _o + (nc ? _rg + (r2m * _g) + _o : 0) + _bm;
        _q.clearRect(0, 0, _c.width, _c.height);

        const p1 = 200, p2 = 500, p3 = 800;
        let bY = _tm + r1m * _g;

        _stk(p1, bY - _o, n1, d1, _cl.b.f, _cl.b.s);
        _fTxt(p1, bY, n1, d1, '\u5206\u6570\u0031');
        _txt((p1+p2)/2, bY - _o - _g/2, op, 'bold 50px sans-serif', _cl.t);
        _stk(p2, bY - _o, n2, d2, _cl.g.f, _cl.g.s);
        _fTxt(p2, bY, n2, d2, '\u5206\u6570\u0032');

        if (!nc) {
            _txt((p2+p3)/2, bY - _o - _g/2, '=', 'bold 50px sans-serif', _cl.t);
            _res(p3, bY, rN1, rN2, cD, op);
        } else {
            const arr = (x, y) => {
                _q.beginPath(); _q.moveTo(x, y); _q.lineTo(x, y + 40); _q.lineTo(x - 10, y + 30);
                _q.moveTo(x, y + 40); _q.lineTo(x + 10, y + 30); _q.strokeStyle = _cl.a; _q.lineWidth = 3; _q.stroke();
            };
            arr(p1, bY - r2m * _g - _rg - _o / 2); arr(p2, bY - r2m * _g - _rg - _o / 2);
            bY += _o + _rg + r2m * _g;
            _stk(p1, bY - _o, rN1, cD, _cl.b.f, _cl.b.s);
            _fTxt(p1, bY, rN1, cD, '\u901a\u5206');
            _txt((p1+p2)/2, bY - _o - _g/2, op, 'bold 50px sans-serif', _cl.s);
            _stk(p2, bY - _o, rN2, cD, _cl.g.f, _cl.g.s);
            _fTxt(p2, bY, rN2, cD, '\u901a\u5206');
            _txt((p2+p3)/2, bY - _o - _g/2, '=', 'bold 50px sans-serif', _cl.t);
            _res(p3, bY, rN1, rN2, cD, op);
        }
    };

    const _res = (x, by, n1, n2, d, op) => {
        const h = by - _o, tN = (op === "+") ? n1 + n2 : n1, fN = (op === "+") ? n1 + n2 : n1 - n2;
        let cn = _m.max(1, _m.ceil(tN / d));
        for (let i = 0; i < cn; i++) {
            let y = h - _r - (i * _g);
            _q.beginPath(); _q.arc(x, y, _r, 0, _m.PI * 2);
            _q.fillStyle = '#fff'; _q.fill();
            for (let j = 0; j < d; j++) {
                let u = i * d + j; if (u >= tN) continue;
                let sA = (_m.PI * 2 / d) * j - _m.PI / 2, eA = (_m.PI * 2 / d) * (j + 1) - _m.PI / 2;
                _q.save();
                if (op === "+") { _q.fillStyle = (u < n1) ? _cl.b.f : _cl.g.f; _q.globalAlpha = 0.8; }
                else {
                    if (u < fN) { _q.fillStyle = _cl.b.f; _q.globalAlpha = 0.8; }
                    else { _q.fillStyle = _cl.g.f; _q.setLineDash([4, 4]); _q.globalAlpha = 0.2; }
                }
                _q.beginPath(); _q.moveTo(x, y); _q.arc(x, y, _r, sA, eA); _q.fill();
                _q.strokeStyle = '#fff'; _q.lineWidth = 2; _q.stroke(); _q.restore();
            }
            _q.beginPath(); _q.arc(x, y, _r, 0, _m.PI * 2); _q.strokeStyle = '#333'; _q.lineWidth = 2; _q.stroke();
        }
        _fTxt(x, by, fN, d, '\u7b54\u3048');
    };

    window._x();
})();
</script>
</body>
</html>
